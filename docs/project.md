
# MoE-Chat 项目文档

## 项目概述

MoE-Chat是一个基于混合专家模型（Mixture of Experts）的智能对话平台，类似于Gemini、Claude、DeepSeek等大模型对话网站。项目采用现代化的前后端分离架构，支持多种MoE模型的高性能推理和实时对话。

### 核心特性

- **多模型支持**：支持DeepSeekMoE、Qwen-MoE、OLMoE等多种混合专家模型
- **高性能推理**：基于vLLM推理引擎，提供OpenAI兼容API
- **实时可视化**：独创的MoE专家激活可视化功能
- **流式生成**：支持流式文本生成，实时显示模型回复
- **思考过程展示**：支持思考模型的思考过程可视化
- **多用户支持**：完整的用户认证和会话管理系统
- **现代化UI**：基于Next.js和shadcn/ui的现代化界面

## 技术架构

### 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Next.js) │    │  后端 (FastAPI)  │    │ 模型服务 (vLLM)  │
│                 │    │                 │    │                 │
│ • React 18      │◄──►│ • Python 3.12  │◄──►│ • OpenAI API   │
│ • TypeScript    │    │ • SQLModel      │    │ • MoE Models    │
│ • Tailwind CSS │    │ • PostgreSQL    │    │ • 专家激活数据   │
│ • shadcn/ui     │    │ • Redis         │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ MoE可视化服务    │
                    │                 │
                    │ • matplotlib    │
                    │ • tkinter       │
                    │ • Redis订阅     │
                    └─────────────────┘
```

### 前端技术栈

- **核心框架**：Next.js 14 (App Router) + React 18 + TypeScript 5+
- **UI组件**：shadcn/ui + Radix UI + Tailwind CSS 3+
- **状态管理**：Zustand + TanStack Query
- **实时通信**：Socket.io-client
- **内容渲染**：React Markdown + KaTeX + React Syntax Highlighter
- **开发工具**：ESLint + Prettier + Husky

### 后端技术栈

- **核心框架**：FastAPI 0.110+ + Python 3.12
- **数据库**：PostgreSQL 17 + pgvector扩展
- **ORM**：SQLModel (基于SQLAlchemy 2.0)
- **缓存**：Redis 7+ (缓存 + 消息队列)
- **认证**：JWT双令牌模式
- **任务队列**：Celery + Flower
- **日志**：Loguru
- **部署**：Docker + Docker Compose

### 模型服务

- **推理引擎**：vLLM高性能推理引擎
- **API兼容**：OpenAI API格式
- **模型支持**：DeepSeekMoE、Qwen-MoE、OLMoE等
- **特色功能**：专家激活数据采集和可视化

## 功能特性

### 用户认证系统

- **注册登录**：支持邮箱注册和登录
- **JWT认证**：采用访问令牌和刷新令牌的双令牌模式
- **邮箱验证**：注册和密码重置需要邮箱验证码
- **用户管理**：支持用户信息编辑、密码修改
- **权限控制**：基于角色的访问控制（RBAC）

### 聊天对话功能

- **多模型支持**：支持多种MoE模型切换
- **流式生成**：实时显示模型回复过程
- **思考过程**：支持思考模型的思考过程展示（可折叠）
- **Markdown渲染**：支持数学公式、代码高亮、表格等
- **文件上传**：支持图片、PDF等文件上传（≤2MB）
- **会话管理**：支持新建、重命名、删除对话
- **历史记录**：侧边栏显示对话历史列表

### MoE专家激活可视化

- **实时可视化**：实时显示专家激活情况
- **热力图展示**：64个专家的激活强度可视化
- **统计信息**：总激活次数、活跃专家数量等
- **TOP排行**：最活跃专家排行榜
- **数据采集**：从vLLM响应中自动提取专家数据

### 系统管理功能

- **健康检查**：数据库、Redis、模型服务状态监控
- **日志管理**：结构化日志记录和查询
- **文件管理**：自动清理未关联文件
- **任务队列**：基于Celery的异步任务处理

## 架构设计

### 后端分层架构

项目采用严格的分层架构设计，提高代码可维护性和可测试性：

1. **API层** (app/api/)
   - 处理HTTP请求和响应
   - 路由注册和参数验证
   - 权限验证和安全控制
   - 依赖注入管理

2. **服务层** (app/services/)
   - 实现核心业务逻辑
   - 协调多个仓库操作
   - 事务管理和一致性保证
   - 领域规则实现

3. **仓库层** (app/db/repositories/)
   - 数据访问抽象
   - CRUD操作封装
   - 查询优化
   - 持久化逻辑

4. **模型层** (app/db/models/)
   - 数据结构定义
   - ORM映射
   - 表关系定义
   - 数据约束

5. **DTO层** (app/db/schemas/)
   - API请求响应模型
   - 服务层输入输出对象
   - 数据验证和转换
   - 类型安全

### 前端分层架构

前端采用基于Next.js App Router的现代化架构：

1. **页面层** (src/app/)
   - 路由定义和页面结构
   - 服务端和客户端组件分离
   - 数据预取和SEO优化
   - 页面级状态管理

2. **组件层** (src/components/)
   - UI基础组件
   - 业务组件
   - 组件复用
   - 组合模式

3. **状态层** (src/store/)
   - 全局状态管理
   - 状态持久化
   - 状态订阅
   - 状态更新逻辑

4. **服务层** (src/services/)
   - API调用封装
   - 数据转换
   - 错误处理
   - 重试逻辑


### 聊天界面

1. **消息列表和渲染**
   - 基于React的消息列表
   - Markdown格式渲染
   - 代码语法高亮
   - KaTeX数学公式渲染
   - 思考过程折叠/展开

2. **消息输入区域**
   - 多行文本输入
   - 文件上传（图片和PDF）
   - 发送/停止生成按钮
   - 文件预览区域

3. **对话历史管理**
   - 侧边栏对话列表
   - 对话搜索功能
   - 新建/重命名/删除对话
   - 对话状态同步

4. **状态管理**
   - Zustand状态管理
   - 消息流式传输
   - 错误处理和重试
   - 思考过程状态管理

5. **响应式设计**
   - 多设备适配
   - 侧边栏折叠/展开

1. 用户认证系统
2. WebSocket连接实现与后端集成
3. 模型选择和配置功能
4. 主题切换（深色/浅色模式）
5. 文件上传和处理的后端集成

## 优化建议

### 1. 后端优化

- **异常处理机制**
  - 实现统一的业务异常类型
  - 全局异常处理中间件
  - 标准化错误响应格式
  - 错误码体系

- **缓存策略**
  - 用户会话信息缓存
  - 热门模型配置缓存
  - 常用查询结果缓存
  - 缓存失效策略

- **监控与日志**
  - 完善应用健康检查API
  - 关键操作审计日志
  - 性能瓶颈监控
  - 定期日志归档和分析

### 2. 前端优化

- **数据获取**
  - 引入React Query优化数据获取和缓存
  - 实现请求去抖动和节流
  - 优化数据预取策略
  - 添加请求重试机制

- **性能优化**
  - 组件懒加载
  - 代码分割
  - 静态资源优化
  - 渲染性能优化

这些优化建议将使MoE-Chat成为一个更加可靠、高性能和易于维护的系统，为用户提供更好的大模型对话体验。